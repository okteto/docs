---
title: Setting up certificates with AWS ACM
description: Setting up certificates with AWS ACM
sidebar_label: AWS ACM
id: aws-acm
---

# Setting up certificates with AWS ACM

This guide outlines the process of setting up certificates issued by or imported into AWS.

## Requirements

- Ensure you have the following tool installed:
  - `aws` CLI v2 version 2.15 or higher. Follow the installation instructions for `aws` CLI v2 [here](https://docs.aws.amazon.com/cli/latest/userguide/getting-started-install.html#getting-started-install-instructions).

## Set Up Variables

### Subdomain Name

```bash
export SUBDOMAIN="devx-platform.yourcompany.com"
```

### AWS Region

Use the snippet below to use your current AWS Region or choose your own value.

```bash
export AWS_REGION="$(aws configure get region)"
```

### Disable AWS CLI v2 Pagination (Optional)

```bash
export AWS_PAGER=""
```

## Create an AWS Route 53 DNS Zone

Your Okteto Self Hosted uses a DNS zone for both its internal endpoints (e.g., registry, kubernetes, buildkit) and also your application endpoints.

```bash
aws route53 create-hosted-zone \
    --name="${SUBDOMAIN}" \
    --caller-reference="$(date +%s)"
```

From the output, take note of the following properties:

- `HostedZone.Id`, set it as the value of the following environment variable:
  
  ```bash
  export HOSTED_ZONE_ID="/hostedzone/replaceme1234567890"
  ```

- `DelegationSet.Nameservers[]`, use them to delegate the DNS zone from your domain nameservers.

:::tip
If you need to recover the nameservers of your DNS zone, you can use the following command:
```bash
aws route53 get-hosted-zone \
  --id="${HOSTED_ZONE_ID}"
```
:::

## Request a Certificate Using AWS ACM with DNS Validation

Okteto Self Hosted uses by default a wildcard certificate that matches its DNS zone.

```bash
aws acm request-certificate \
    --domain-name="*.${SUBDOMAIN}" \
    --validation-method="DNS" \
    --region="${AWS_REGION}"
```

From the output, take note of the following properties:

- `CertificateArn`, it identifies the certificate for usage in AWS integrated services.
  
  ```bash
  export CERTIFICATE_ARN="arn:aws:acm:eu-central-1:111122223333:certificate/replaceme1234567890"
  ```

## Publish the Validation Records to the DNS Zone

:::warning
Before continuing, ensure that the DNS zone you created is authoritative and correctly delegated from your main domain.
:::

Get the validation records:

```bash
aws acm describe-certificate \
  --certificate-arn="${CERTIFICATE_ARN}" \
  --region="${AWS_REGION}" \
  --query='Certificate.DomainValidationOptions[0].ResourceRecord'
```

Create a change batch file and replace the values highlighted:

```json title="resource-record.json"
{
  "Comment": "Add a CNAME record for foo to point to bar.com",
  "Changes": [
    {
      "Action": "CREATE",
      "ResourceRecordSet": {
        // highlight-next-line
        "Name": "REPLACE ME WITH RESOURCE RECORD NAME",
        "Type": "CNAME",
        "TTL": 300,
        "ResourceRecords": [
          {
            // highlight-next-line
            "Value": "REPLACE ME WITH RESOURCE RECORD VALUE"
          }
        ]
      }
    }
  ]
}
```

Publish the validation records:

```bash
aws route53 change-resource-record-sets \
  --hosted-zone-id="${HOSTED_ZONE_ID}" \
  --change-batch=file://resource-record.json
```

Watch the status of the validation:

```bash
aws acm describe-certificate \
  --certificate-arn="${CERTIFICATE_ARN}" \
  --region="${AWS_REGION}" \
  --query='Certificate.DomainValidationOptions[0].ValidationStatus'
```

It will eventually change from `PENDING_VALIDATION` to `SUCCESS`.

:::tip
You can actively block and wait until your certificate is validated with the following command:

```bash
aws acm wait certificate-validated \
  --certificate-arn="${CERTIFICATE_ARN}" \
  --region="${AWS_REGION}"
```

It internally polls the AWS API every 60 seconds. It will exit with a 255 exit code after 40 failed attempts.
:::

## Use the Certificate in Your Okteto Self Hosted Instances

Apply the following snippet to your Helm release configuration and replace the highlighted value:

```yaml title="Helm release configuration"
ingress-nginx:
  controller:
    service:
      annotations:
        service.beta.kubernetes.io/aws-load-balancer-type: "nlb"
        service.beta.kubernetes.io/aws-load-balancer-backend-protocol: "ssl"
        // highlight-next-line
        service.beta.kubernetes.io/aws-load-balancer-ssl-cert: "arn:aws:acm:eu-central-1:111122223333:certificate/replaceme1234567890"
        service.beta.kubernetes.io/aws-load-balancer-ssl-ports: "https"
        service.beta.kubernetes.io/aws-load-balancer-scheme: "internet-facing" 
        service.beta.kubernetes.io/aws-load-balancer-alpn-policy: "HTTP2Preferred"
```