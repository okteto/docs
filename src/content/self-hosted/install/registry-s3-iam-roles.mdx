---
title: Registry S3 Access via IAM Roles
description: How to Setup Okteto Self Hosted Registry with S3 access via IAM Roles
id: registry-s3-iam-roles
---

# Setup Registry with S3 Access via IAM Roles

This guide will show you how to setup Okteto Self Hosted Registry with S3 access via IAM Roles.

## Requirements

- Ensure you have the following tool installed:
  - `eksctl` version 0.171 or higher. You can find installation instructions for `eksctl` [here](https://eksctl.io/installation/).
  - `aws` CLI v2 version 2.15 or higher. Follow the installation instructions for `aws` CLI v2 [here](https://docs.aws.amazon.com/cli/latest/userguide/getting-started-install.html#getting-started-install-instructions).


## Set Up Variables

### Cluster Name

```bash
export CLUSTER_NAME="okteto-cluster"
```

### Bucket Name

Use the snippet below to use your own bucket name or choose your own value.

```bash
export BUCKET_NAME="${CLUSTER_NAME}-registry-bucket"
```

:::tip
S3 bucket names are globally unique. You will need to choose a unique name for your bucket. You can include a random string in the bucket name to ensure it is unique.
:::

### AWS Region

Use the snippet below to use your current AWS Region or choose your own value.

```bash
export AWS_REGION="$(aws configure get region)"
```

### AWS Account ID

Use the following snippet to use your current AWS Account ID or choose your own value.

```bash
export AWS_ACCOUNT_ID="$(aws sts get-caller-identity --query "Account" --output text)"
```

### Disable AWS CLI v2 Pagination (Optional)

```bash
export AWS_PAGER=""
```

## Create S3 bucket

```bash
aws s3api create-bucket \
  --bucket="${BUCKET_NAME}" \
  --region="${AWS_REGION}" \
  --create-bucket-configuration=LocationConstraint="${AWS_REGION}"
```

## Create IAM Role

Save the following IAM Policy definition to a file and modify the `Resource` field to match your S3 bucket name:

```json title="okteto-registry-iam-policy.json"
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": [
        "s3:ListBucket",
        "s3:GetBucketLocation",
        "s3:ListBucketMultipartUploads"
      ],
      // highlight-next-line
      "Resource": "arn:aws:s3:::REPLACE-ME-WITH-YOUR-BUCKET-NAME"
    },
    {
      "Effect": "Allow",
      "Action": [
        "s3:PutObject",
        "s3:GetObject",
        "s3:DeleteObject",
        "s3:ListMultipartUploadParts",
        "s3:AbortMultipartUpload"
      ],
      // highlight-next-line
      "Resource": "arn:aws:s3:::REPLACE-ME-WITH-YOUR-BUCKET-NAME/*"
    }
  ]
}
```

:::note
The IAM policy is maintained by `distribution/distribution` project. You can find the latest version of the policy [here](https://distribution.github.io/distribution/storage-drivers/s3/#s3-permission-scopes).
:::

Create the IAM Policy:

```bash
aws iam create-policy \
  --policy-name="${CLUSTER_NAME}-okteto-registry-policy" \
  --policy-document="file://okteto-registry-iam-policy.json"
```

Set the Kubernetes Service Account Name:

```bash
export SERVICE_ACCOUNT_NAME="$(kubectl get sa -n=okteto -l=app.kubernetes.io/component=registry -o=jsonpath='{.items[0].metadata.name}')"
```

Create the IAM Role:

```bash
eksctl create iamserviceaccount \
  --region="${AWS_REGION}" \
  --name="${SERVICE_ACCOUNT_NAME}" \
  --namespace="okteto" \
  --cluster="${CLUSTER_NAME}" \
  --role-name="${CLUSTER_NAME}-okteto-registry-role" \
  --role-only \
  --attach-policy-arn="arn:aws:iam::${AWS_ACCOUNT_ID}:policy/${CLUSTER_NAME}-okteto-registry-policy" \
  --approve
```

## Use the Role in Your Okteto Self Hosted Instances

Set the IAM Role ARN:

```bash
export ROLE_ARN="arn:aws:iam::${AWS_ACCOUNT_ID}:role/${CLUSTER_NAME}-okteto-registry-role"
```

Apply the following snippet to your Helm release configuration and replace the highlighted value:

```yaml title="Registry S3 IAM Role"
registry:
  storage:
    provider:
      aws:
        enabled: true
        // highlight-next-line
        bucket: "REPLACE ME WITH YOUR BUCKET NAME"
        // highlight-next-line
        region: "REPLACE ME WITH YOUR AWS REGION"
        iam:
          enabled: false
  serviceAccount:
    annotations:
      // highlight-next-line
      eks.amazonaws.com/role-arn: "REPLACE_ME_WITH_YOUR_ROLE_ARN"
```

:::note
If you followed the [AWS Cloud Provider guide](get-started/cloud-provider-guides/eks.mdx), replace the whole `registry.storage` section with the one above.
:::
